name: pr-validator
on:
  pull_request:
    paths:
      - 'oci/*/*.y*ml'

jobs:
  get-submitted-files:
    runs-on: ubuntu-22.04
    name: Get submitted files
    outputs:
      changed-files: ${{ steps.changed-files.outputs.all_changed_files }}
      changed-files-matrix: ${{ steps.changed-files-matrix.outputs.matrix }}
      image-name: ${{ steps.changed-files-dir-names.outputs.all_changed_files }}
      trigger-builds: ${{ steps.needs-builds.outputs.trigger-builds }}
    steps:
      - uses: actions/checkout@v3
      
      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v35
        with:
          json: true

      - name: Get image name
        id: changed-files-dir-names
        uses: tj-actions/changed-files@v35
        with:
          dir_names: "true"

      - name: Only 1 image can be changed per PR
        run: |
          set -eux
          dir_names="${{ steps.changed-files-dir-names.outputs.all_changed_files }}"
          echo "Can only modify 1 image per PR"
          (( $(echo "${dir_names}" | wc -w) == 1 ))

      - name: Save matrix layout for next job
        id: changed-files-matrix
        run: |
          echo 'Changed files are: ${{ steps.changed-files.outputs.all_changed_files }}'
          echo "matrix={\"filename\":${{ steps.changed-files.outputs.all_changed_files }}}" >> "$GITHUB_OUTPUT"

      - name: Check if builds are needed
        id: needs-builds
        run: |
          set -eux
          changed_files="${{ steps.changed-files.outputs.all_changed_files }}"
          if [[ "${changed_files}" == *"builds.yaml"* ]]
          then
            echo "trigger-builds='true'" >> $GITHUB_OUTPUT
          else
            echo "trigger-builds='false'" >> $GITHUB_OUTPUT
          fi

  check-missing-files:
    runs-on: ubuntu-22.04
    name: Check for missing files
    needs: [get-submitted-files]
    steps:
      - uses: actions/checkout@v3

      - name: Check if documentation.yaml exists
        uses: andstor/file-existence-action@v2
        with:
          files: "${{ needs.get-submitted-files.outputs.image-name }}/documentation.yaml"
          fail: true

      - name: Check if contacts.yaml exists
        uses: andstor/file-existence-action@v2
        with:
          files: "${{ needs.get-submitted-files.outputs.image-name }}/contacts.yaml"
          fail: true

  validate-submitted-files:
    runs-on: ubuntu-22.04
    name: Validate files
    needs: [get-submitted-files]
    strategy:
      fail-fast: true
      matrix: ${{ fromJSON(needs.get-submitted-files.outputs.changed-files-matrix) }}
    steps:
      - uses: actions/checkout@v3

      - name: Validate YAML format
        run: |
          set -eux
          pip install yamllint
          yamllint -c .yamllint.yaml ${{ matrix.filename }}

  build:
    needs: [validate-submitted-files, get-submitted-files, check-missing-files]
    if: needs.get-submitted-files.outputs.trigger-builds == 'true'
    uses: ./.github/workflows/builds.yaml
    with:
      image: ${{ needs.get-submitted-files.outputs.image-name }}
      upload: ${{ github.ref_name == 'main' && true || false }}
