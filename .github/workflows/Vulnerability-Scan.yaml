name: Vulnerability Scan
run-name: 'Vulnerability Scan - ${{ inputs.oci-image-name }} - ${{ github.ref }}'

on:
  workflow_call:
    inputs:
      oci-image-name:
        description: 'Name of the image to be fetched and tested'
        required: true
        type: string
      oci-image-path:
        description: 'Path to the image in OCI Factory (eg. "oci/foo")'
        required: false
        type: string
      trivyignore-path:
        description: 'Path to the .trivygnore file'
        required: false
        type: string
      date-last-scan:
        description: 'If there are new CVEs after this date, we notify'
        required: false
        type: string
        default: '9999-12-31T23:59:59'
      create-issue:
        description: 'If to create a GitHub issues for found vulnerabilities'
        required: false
        type: boolean
        default: false

env:
  VULNERABILITY_REPORT_SUFFIX: '.vulnerability-report.json' # TODO: inherit string from caller
  SKOPEO_IMAGE: 'quay.io/skopeo/stable:v1.20.0'

jobs:
  configure-scan:
    runs-on: ubuntu-22.04
    name: "configure-scan ${{ inputs.oci-image-name != '' && format('| {0}', inputs.oci-image-name) || ' '}}"
    outputs:
      oci-image: ${{ steps.configure.outputs.oci-filename }}
      vulnerability-report: ${{ steps.configure.outputs.report-filename }}
    steps:
      - name: Check required input
        run: |
          if [ "${{ github.repository }}" = "canonical/oci-factory" ] && [ -z "${{ inputs.oci-image-path }}" ]; then
            echo "missing required input: oci-image-path"
            exit 1
          fi

      - id: configure
        run: |
          oci_filename="$(basename "${{ inputs.oci-image-name }}" | tr ':' '_')"

          echo "oci-filename=$oci_filename" >> "$GITHUB_OUTPUT"
          echo "report-filename=${oci_filename}${{ env.VULNERABILITY_REPORT_SUFFIX }}" >> "$GITHUB_OUTPUT"

          docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
            -v $PWD:/workdir -w /workdir \
            ${{ env.SKOPEO_IMAGE }} \
            copy docker://${{ inputs.oci-image-name }} \
            oci-archive:$oci_filename \
            --src-username "${{ github.actor }}" \
            --src-password "${{ secrets.GITHUB_TOKEN }}"

      - uses: actions/upload-artifact@v4
        if: ${{ !cancelled() }}
        with:
          name: ${{ steps.configure.outputs.oci-filename }}
          path: ${{ steps.configure.outputs.oci-filename }}
          retention-days: 1

  test-vulnerabilities:
    name: "test-vulnerabilities ${{ inputs.oci-image-name != '' && format('| {0}', inputs.oci-image-name) || ' '}}"
    uses: ./.github/workflows/Test-Rock.yaml
    needs: [configure-scan]
    with:
      oci-archive-name: ${{ needs.configure-scan.outputs.oci-image }}
      test-vulnerabilities: true # just incase we set this to false by default in the future
      trivyignore-path: ${{ inputs.trivyignore-path }}
      test-black-box: false
      test-efficiency: false
      test-malware: false
      test-oci-compliance: false
    permissions:
      contents: read

  parse-results:
    name: "parse-results ${{ inputs.oci-image-name != '' && format('| {0}', inputs.oci-image-name) || ' '}}"
    runs-on: ubuntu-22.04
    needs: [configure-scan, test-vulnerabilities]
    if: ${{ !cancelled() }}
    outputs:
      notify: ${{ steps.check-report.outputs.notify }}
      vulnerabilities: ${{ steps.check-report.outputs.vulnerabilities }}
    steps:
      - uses: actions/checkout@v4

      - name: Validate access to triggered image
        uses: ./.github/actions/validate-actor
        if: 
          github.repository == 'canonical/oci-factory' && !github.event.pull_request.head.repo.fork &&
          github.event_name != 'schedule'
        with:
          admin-only: true
          image-path: ${{ inputs.oci-image-path }}
          github-token: ${{ secrets.ROCKSBOT_TOKEN }}

      - name: Download Vulnerability Report
        uses: actions/download-artifact@v4
        with:
          name: '${{ needs.configure-scan.outputs.vulnerability-report }}'

      - name: Process report
        if: ${{ !cancelled() }}
        id: check-report
        run: |
          report="${{ needs.configure-scan.outputs.vulnerability-report }}" 
          echo "notify=false" >> "$GITHUB_OUTPUT"
          if [[ "$RUNNER_DEBUG" == "1" ]]; then
            set -x
          fi
          vulnerabilities="$(jq -r -c '[
                  try(.scanner.result.Results[])
                  | .Target as $target
                  | .Vulnerabilities
                  | select(. != null)
                  | .[]
                  | {Target: $target, LastModifiedDate: .LastModifiedDate, VulnerabilityID: .VulnerabilityID,
                     PkgName: .PkgName, Severity: .Severity}
                ]' < $report)"
          echo "vulnerabilities=$vulnerabilities" >> "$GITHUB_OUTPUT"
          last_modified_dates="$(echo "$vulnerabilities" | jq -r '.[] | select(.LastModifiedDate != null) | .LastModifiedDate')"
          cat "$GITHUB_OUTPUT"
          # We want to notify only if the CVEs have been updated since the last
          # time this scan ran
          for cve_updated in $last_modified_dates
          do
            if [[ "$cve_updated" > "${{ inputs.date-last-scan }}" ]]
            then
              echo "notify=true" >> "$GITHUB_OUTPUT"
              break
            fi
          done

  # Many workflows are now using a similar notification job. It would be better
  # if this was a common workflows reachable via a workflow_call
  notify:
    name: "notify ${{ inputs.oci-image-name != '' && format('| {0}', inputs.oci-image-name) || ' '}}"
    runs-on: ubuntu-22.04
    needs: [parse-results]
    if: ${{ !cancelled() && github.repository == 'canonical/oci-factory' && needs.parse-results.outputs.notify == 'true' }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.x'
  
      - run: pip install -r src/notifications/requirements.txt

      - name: Get contacts for ${{ inputs.oci-image-name }}
        id: get-contacts
        working-directory: ${{ inputs.oci-image-path }}
        run: |
          mm_channels=$(yq -r '.notify | ."mattermost-channels" | join(",")' < contacts.y*ml)
          echo "mattermost-channels=${mm_channels}" >> "$GITHUB_OUTPUT"

      - name: Notify via Mattermost
        env:
          MM_BOT_TOKEN: ${{ secrets.MM_BOT_TOKEN }}
          FINAL_STATUS: failure
          MM_SERVER: ${{ secrets.MM_SERVER }}
          URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          SUMMARY: ''
          FOOTER: ''
          TITLE: 'Vulnerabilities found for ${{ inputs.oci-image-name }}'
        run: |
          for channel in $(echo ${{ steps.get-contacts.outputs.mattermost-channels }} | tr ',' ' ')
          do
            MM_CHANNEL_ID="${channel}" python3 -m src.notifications.mattermost_notifier send
          done

  issue:
    name: "issue ${{ inputs.oci-image-name != '' && format('| {0}', inputs.oci-image-name) || ' '}}"
    runs-on: ubuntu-22.04
    needs: [parse-results, test-vulnerabilities]
    env:
      GITHUB_TOKEN: ${{ secrets.ROCKSBOT_TOKEN }}
    if: ${{ !cancelled() && github.event_name != 'pull_request' }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - run: pip install pydantic==2.12.3

      - id: simplify-image-name
        run: |
          img_name_with_tag=$(echo "${{ inputs.oci-image-name }}" | sed -r 's|.*/([a-zA-Z0-9-]+:[0-9.-]+_[0-9])+|\1|')
          img_name=$(echo "${img_name_with_tag}" | cut -d ':' -f 1)
          img_revision=$(echo "${img_name_with_tag}" | cut -d '_' -f 2)
          echo "img_revision=$img_revision" >> "$GITHUB_OUTPUT"
          echo "img_name_with_tag=$img_name_with_tag" >> "$GITHUB_OUTPUT"
          echo "img_name=$img_name" >> "$GITHUB_OUTPUT"

      # We assume that the sources within image.yaml are the same
      - name: Get image repo
        id: get-image-repo
        run: |
          if [[ -n "${{ inputs.oci-image-path }}" ]]; then
            img_repo=$(yq -r '.upload.[].source' "${{ github.workspace }}/${{ inputs.oci-image-path }}/image.yaml" | head -n 1)
          else
            img_repo="${{ github.repository }}"
          fi
          echo "img-repo=$img_repo" >> "$GITHUB_OUTPUT"

      - name: Fetch _releases.json
        if: github.repository == 'canonical/oci-factory' && steps.simplify-image-name.outputs.img_name != ''
        uses: canonical/oci-factory/.github/actions/fetch-releases-json@main
        with:
          image-name: ${{ steps.simplify-image-name.outputs.img_name }}

      # We have to walk through the vulnerabilities since trivy does not support outputting the results as Markdown
      - name: Create markdown content
        id: create-markdown
        run: |
          if [[ "$RUNNER_DEBUG" == "1" ]]; then
            set -x
          fi
          num_vulns=$(echo '${{ needs.parse-results.outputs.vulnerabilities }}' | jq -r 'length')
          vulnerability_exists=$([[ $num_vulns -gt 0 ]] && echo 'true' || echo 'false')
          echo "vulnerability-exists=$vulnerability_exists" >> "$GITHUB_OUTPUT"
          if [[ $vulnerability_exists == 'true' ]]; then
            title="Vulnerabilities found for ${{ steps.simplify-image-name.outputs.img_name_with_tag }}"
            echo "## $title" > issue.md
            echo "| ID | Target | Severity | Package |" >> issue.md
            echo "| -- | ----- | -------- | ------- |" >> issue.md
            echo '${{ needs.parse-results.outputs.vulnerabilities }}' | jq -r '.[] | "| \(.VulnerabilityID) | /\(.Target) | \(.Severity) | \(.PkgName) |"' >> issue.md
            if [[ "${{ inputs.create-issue }}" == 'true' ]]; then
              release_json="${{ inputs.oci-image-path }}/_releases.json"
              if [[ -f "$release_json" ]]; then
                revision_to_released_tags=$(python3 -m src.shared.release_info get_revision_to_released_tags --all-releases "$release_json")
                affected_tracks=$(echo "${revision_to_released_tags}" | jq -r '."${{ steps.simplify-image-name.outputs.img_revision }}" | map("- `\(.)`") | join("\n")')
                echo -e "\n### Affected tracks:" >> issue.md
                echo -e "${affected_tracks}" >> issue.md
              fi
              echo -e "\nDetails: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> issue.md
            fi
            echo "issue-title=$title" >> "$GITHUB_OUTPUT"
            echo "issue-body-file=issue.md" >> "$GITHUB_OUTPUT"
          fi

      - id: issue-exists
        if: ${{ inputs.create-issue}}
        run: |
          issue_number=$(gh issue list --repo ${{ steps.get-image-repo.outputs.img-repo }} --json "number,title" \
                  | jq -r '.[] | select(.title == "${{ steps.create-markdown.outputs.issue-title }}") | .number')
          echo "issue-exists=$([[ -n "$issue_number" ]] && echo 'true' || echo 'false')" >> "$GITHUB_OUTPUT"
          echo "issue-number=$issue_number" >> "$GITHUB_OUTPUT"

      # Truth table for issue creation
      # | issue-exists | notify | vulnerability-exists |   op   |
      # |--------------|--------|----------------------|--------|
      # |      T       |   T    |          T           | update |
      # |      T       |   T    |          F           |  never |
      # |      T       |   F    |          T           |   nop  |
      # |      T       |   F    |          F           |  close |
      # |      F       |   T    |          T           | create |
      # |      F       |   T    |          F           |  never |
      # |      F       |   F    |          T           | create |
      # |      F       |   F    |          F           |   nop  |

      - name: Notify via GitHub issue
        if: ${{ steps.create-markdown.outputs.vulnerability-exists == 'true' && inputs.create-issue }}
        run: |
          if [[ "$RUNNER_DEBUG" == "1" ]]; then
            set -x
          fi
          op=nop
          if [[ ${{ steps.issue-exists.outputs.issue-exists }}  == 'false' ]]; then
            op="create"
          elif [[ ${{ steps.issue-exists.outputs.issue-exists }} == 'true' \
                  && ${{ needs.parse-results.outputs.notify }} == 'true' ]]; then
            op="edit ${{ steps.issue-exists.outputs.issue-number }}"
          fi
          if [[ $op != 'nop' ]]; then
            gh issue $op --repo ${{ steps.get-image-repo.outputs.img-repo }} \
              --title "${{ steps.create-markdown.outputs.issue-title }}" \
              --body-file "${{ steps.create-markdown.outputs.issue-body-file }}"
          fi

      - name: Close issue
        if: |
          needs.test-vulnerabilities.result == 'success' && 
          steps.issue-exists.outputs.issue-exists == 'true' && 
          steps.create-markdown.outputs.vulnerability-exists == 'false' && 
          inputs.create-issue
        run: |
          gh issue close ${{ steps.issue-exists.outputs.issue-number }} --repo ${{ steps.get-image-repo.outputs.img-repo }}
